<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tally Help Desk</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <header class="text-center mb-8">
            <img src="https://placehold.co/150x50/003366/FFFFFF?text=Tally" alt="Tally Logo" class="mx-auto mb-4 rounded">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Tally Help Desk</h1>
            <p class="text-gray-600 mt-2">Your one-stop solution for all Tally-related queries.</p>
        </header>

        <main class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Ask a Question</h2>
            <div class="relative">
                <input type="text" id="searchInput" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your question here...">
                <div id="suggestions" class="absolute z-10 w-full bg-white border border-gray-300 mt-1 rounded-lg shadow-lg hidden"></div>
            </div>
            <div id="answerContainer" class="mt-6 p-4 bg-blue-50 rounded-lg hidden">
                <h3 class="font-bold text-lg text-blue-800">Answer:</h3>
                <div id="answerContent" class="prose max-w-none text-gray-700 mt-2"></div>
            </div>
        </main>

        <aside class="mt-8 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Available Questions</h2>
            <ul id="questionsList" class="space-y-3">
                <li>Loading questions...</li>
            </ul>
        </aside>

        <footer class="text-center mt-12 py-6 border-t border-gray-300">
            <h3 class="text-lg font-semibold">Contact Us</h3>
            <p class="text-gray-600 mt-2">For further assistance, please reach out to our support team.</p>
            <p class="text-gray-600">Email: <a href="mailto:support@tallysolutions.com" class="text-blue-600 hover:underline">support@tallysolutions.com</a></p>
            <p class="text-gray-600">Phone: 1-800-425-8859</p>
        </footer>

    </div>

    <script>
        // --- NEW: Global Helper Function for Lazy-Loading Video ---
        // This function is called when a video thumbnail is clicked.
        function playYouTubeVideo(element, videoId) {
            const iframeHtml = `
                <div class="aspect-w-16 aspect-h-9">
                    <iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen 
                            class="rounded-lg shadow-sm">
                    </iframe>
                </div>`;
            // The element that was clicked is the thumbnail container.
            // We replace its content with the iframe player.
            element.innerHTML = iframeHtml;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSepXk6D6pz8VbdpwO3UkhOrH77gY1yLXCCXieh2GhgTxM0qj1bukNFa8xpeUDwxQrAz9maQdHKYi-Y/pub?output=csv';

            // --- DOM Element References ---
            const questionsList = document.getElementById('questionsList');
            const searchInput = document.getElementById('searchInput');
            const suggestions = document.getElementById('suggestions');
            const answerContainer = document.getElementById('answerContainer');
            const answerContent = document.getElementById('answerContent');

            // --- Local Data Store ---
            let localData = [];

            // --- API object for interacting with data ---
            const api = {
                fetchSheetData: async () => {
                    try {
                        if (GOOGLE_SHEET_URL === 'YOUR_PUBLISHED_GOOGLE_SHEET_CSV_URL_HERE' || !GOOGLE_SHEET_URL) {
                            throw new Error("Google Sheet URL is not configured. Please paste it into the script.");
                        }
                        const response = await fetch(GOOGLE_SHEET_URL);
                        if (!response.ok) throw new Error(`Failed to fetch data. Status: ${response.status}`);
                        
                        const csvText = await response.text();
                        const parsedData = Papa.parse(csvText, {
                            header: true,
                            delimiter: ",", 
                            skipEmptyLines: true,
                        });
                        
                        return parsedData.data.filter(item => item.Question && item.Question.trim() !== '');

                    } catch (error) {
                        console.error("Error fetching or parsing sheet data:", error);
                        questionsList.innerHTML = `<li><strong>Error:</strong> ${error.message}</li>`;
                        return [];
                    }
                },
                getAllQuestions: () => localData,
                searchQuestions: (query) => {
                    if (!query) return [];
                    const lowerCaseQuery = query.toLowerCase();
                    return localData.filter(item => item.Question.toLowerCase().includes(lowerCaseQuery));
                }
            };

            // --- UI Helper Functions ---
            const createClickableListItem = (item) => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.className = 'text-left w-full text-blue-600 hover:underline focus:outline-none';
                button.textContent = item.Question;
                button.onclick = () => displayAnswer(item);
                li.appendChild(button);
                return li;
            };

            const displayAnswer = (item) => {
                let htmlContent = '';

                if (item['Step-by-Step Answer']) {
                    htmlContent += `<pre class="whitespace-pre-wrap font-sans text-base">${item['Step-by-Step Answer']}</pre>`;
                }

                if (item['Image Link'] && item['Image Link'].trim() !== '') {
                    const imageContainerId = `image-container-${item.ID}`;
                    htmlContent += `
                        <div class="mt-4 pt-4 border-t" id="${imageContainerId}">
                            <h4 class="font-semibold text-gray-800">Reference Image:</h4>
                            <img src="${item['Image Link']}" 
                                 alt="Reference for ${item.Question}" 
                                 class="mt-2 rounded-lg border shadow-sm max-w-full h-auto"
                                 onerror="document.getElementById('${imageContainerId}').style.display='none';">
                        </div>
                    `;
                }

                if (item['Video Link'] && item['Video Link'].trim() !== '') {
                    let videoEmbedHtml = '';
                    const videoUrl = item['Video Link'];
                    const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
                    const youtubeMatch = videoUrl.match(youtubeRegex);

                    if (youtubeMatch && youtubeMatch[1]) {
                        const videoId = youtubeMatch[1];
                        const videoContainerId = `video-container-${item.ID}`;
                        const thumbnailUrl = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;
                        
                        // --- UPDATED AND SIMPLIFIED VIDEO HANDLING ---
                        videoEmbedHtml = `
                            <div onclick="playYouTubeVideo(this, '${videoId}')" class="relative cursor-pointer group bg-gray-200 rounded-lg">
                                <img src="${thumbnailUrl}" class="w-full rounded-lg shadow-sm border" onerror="document.getElementById('${videoContainerId}').style.display='none';">
                                <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-40 rounded-lg group-hover:bg-opacity-20 transition-all">
                                    <svg class="w-16 h-16 text-white opacity-90 drop-shadow-lg" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                                </div>
                            </div>
                        `;

                        htmlContent += `
                            <div class="mt-4 pt-4 border-t" id="${videoContainerId}">
                                <h4 class="font-semibold text-gray-800">Reference Video:</h4>
                                <div class="mt-2">${videoEmbedHtml}</div>
                            </div>
                        `;

                    } else {
                        htmlContent += `<div class="mt-4 pt-4 border-t"><a href="${videoUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">Watch Video Tutorial</a></div>`;
                    }
                }
                
                answerContent.innerHTML = htmlContent;
                answerContainer.classList.remove('hidden');
                searchInput.value = item.Question;
                suggestions.classList.add('hidden');
                answerContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            };


            // --- Main Initialization Function ---
            const loadInitialData = async () => {
                localData = await api.fetchSheetData();
                if (localData.length === 0 && questionsList.textContent.includes('Error')) return;

                questionsList.innerHTML = '';
                const allQuestions = api.getAllQuestions();

                if (allQuestions.length > 0) {
                    allQuestions.forEach(q => questionsList.appendChild(createClickableListItem(q)));
                } else {
                    questionsList.innerHTML = '<li>No questions found. Check the data source and configuration.</li>';
                }
            };

            // --- Event Listeners ---
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.trim();
                suggestions.classList.add('hidden');
                if (query.length < 2) return;

                const results = api.searchQuestions(query);
                suggestions.innerHTML = '';
                if (results.length > 0) {
                    results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'p-3 cursor-pointer suggestion-item';
                        const questionText = item.Question;
                        const regex = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                        div.innerHTML = questionText.replace(regex, '<strong>$1</strong>');
                        div.onclick = () => displayAnswer(item);
                        suggestions.appendChild(div);
                    });
                    suggestions.classList.remove('hidden');
                }
            });

            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = searchInput.value;
                    const results = api.searchQuestions(query);
                    if (results.length > 0) {
                        displayAnswer(results[0]);
                    } else {
                        answerContent.innerHTML = "<p>Sorry, we couldn't find an answer. Please try rephrasing your question or check the available questions list.</p>";
                        answerContainer.classList.remove('hidden');
                    }
                    suggestions.classList.add('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.classList.add('hidden');
                }
            });

            // --- Start the application ---
            loadInitialData();
        });
    </script>

</body>
</html>
